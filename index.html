<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SplitSmart - House Expenses</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & Babel for Browser -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .modal-enter { animation: zoomIn 0.2s ease-out; }
        @keyframes zoomIn {
            from { opacity: 0; transform: scale(0.98); }
            to { opacity: 1; transform: scale(1); }
        }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 font-sans">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, onSnapshot, query, where, serverTimestamp, updateDoc, arrayUnion, getDocs } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        // --- YOUR FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyAg5PYPLSBIOlIwTypFkNf8BRGgnIS3FXY",
            authDomain: "splitsmart-889da.firebaseapp.com",
            projectId: "splitsmart-889da",
            storageBucket: "splitsmart-889da.firebasestorage.app",
            messagingSenderId: "265383787810",
            appId: "1:265383787810:web:de28c8f28ce1fd9a9bf97b",
            measurementId: "G-ZN3B2YLXVT"
        };

        const appId = "splitsmart-889da";
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const { useState, useEffect, useMemo } = React;

        // Inline SVGs to avoid library crashes
        const Icons = {
            food: <svg size="20" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2M7 2v20M21 15V2a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3Zm0 0v7"></path></svg>,
            construction: <svg size="20" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="m22 2-8 4-10 12L2 22l4-2 12-10L22 2Z"></path></svg>,
            car: <svg size="20" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M19 17h2c.6 0 1-.4 1-1v-3c0-.9-.7-1.7-1.5-1.9C18.7 10.6 16 10 16 10s-1.3-1.4-2.2-2.3c-.5-.4-1.1-.7-1.8-.7H5c-.6 0-1.1.4-1.4.9l-1.4 2.9A3.7 3.7 0 0 0 2 13.1V16c0 .6.4 1 1 1h2"></path><circle cx="7" cy="17" r="2"></circle><circle cx="17" cy="17" r="2"></circle></svg>,
            rent: <svg size="20" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>,
            receipt: <svg size="20" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><rect width="16" height="20" x="4" y="2" rx="2"></rect><line x1="8" x2="16" y1="6" y2="6"></line><line x1="8" x2="16" y1="10" y2="10"></line><line x1="8" x2="12" y1="14" y2="14"></line></svg>,
            userPlus: <svg size="20" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><line x1="19" x2="19" y1="8" y2="14"></line><line x1="16" x2="22" y1="11" y2="11"></line></svg>,
            plus: <svg size="20" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><line x1="12" x2="12" y1="5" y2="19"></line><line x1="5" x2="19" y1="12" y2="12"></line></svg>,
            settle: <svg size="20" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>
        };

        const CATEGORIES = [
            { id: 'food', name: 'Food', icon: 'food' },
            { id: 'construction', name: 'Home Construction', icon: 'construction' },
            { id: 'car', name: 'Car', icon: 'car' },
            { id: 'rent', name: 'Rent', icon: 'rent' },
            { id: 'other', name: 'Other', icon: 'receipt' },
        ];

        function App() {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [groups, setGroups] = useState([]);
            const [activeGroup, setActiveGroup] = useState(null);
            const [showAddExpense, setShowAddExpense] = useState(false);
            const [showInviteModal, setShowInviteModal] = useState(false);
            const [newGroupName, setNewGroupName] = useState("");
            const [inviteEmail, setInviteEmail] = useState("");
            const [paymentType, setPaymentType] = useState("paid_by_me_split_equally");
            const [errorMessage, setErrorMessage] = useState(null);

            useEffect(() => {
                const unsubscribe = onAuthStateChanged(auth, async (u) => {
                    setUser(u);
                    setLoading(false);
                    if (u && u.email) {
                        const email = u.email.toLowerCase();
                        try {
                            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'groups'), where('memberEmails', 'array-contains', email));
                            const snapshot = await getDocs(q);
                            snapshot.docs.forEach(async (groupDoc) => {
                                const members = groupDoc.data().members || [];
                                let needsUpdate = false;
                                const updatedMembers = members.map(m => {
                                    if (m && m.email?.toLowerCase() === email && (!m.joined || m.uid?.startsWith('guest_'))) {
                                        needsUpdate = true;
                                        return { ...m, uid: u.uid, name: u.displayName || m.name || 'User', joined: true };
                                    }
                                    return m;
                                });
                                if (needsUpdate) {
                                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'groups', groupDoc.id), {
                                        members: updatedMembers,
                                        memberIds: arrayUnion(u.uid)
                                    });
                                }
                            });
                        } catch (err) { console.error("Sync error:", err); }
                    }
                });
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (!user || !user.email) return;
                const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'groups'), where('memberEmails', 'array-contains', user.email.toLowerCase()));
                return onSnapshot(q, (snapshot) => {
                    const gData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setGroups(gData);
                    if (activeGroup) {
                        const updated = gData.find(g => g.id === activeGroup.id);
                        if (updated) setActiveGroup(updated);
                    } else if (gData.length > 0) setActiveGroup(gData[0]);
                }, (err) => {
                    if (err.code === 'permission-denied') setErrorMessage("Permission Denied: Ensure you published the Rules in Firebase Console.");
                });
            }, [user?.email, activeGroup?.id]);

            const stats = useMemo(() => {
                if (!activeGroup || !user) return { total: 0, perPerson: 0, balances: [] };
                const expenses = activeGroup.expenses || [];
                const members = (activeGroup.members || []).filter(m => m && m.uid);
                const total = expenses.reduce((sum, exp) => sum + (exp.amount || 0), 0);
                const netBalances = {};
                members.forEach(m => { netBalances[m.uid] = 0; });

                expenses.forEach(exp => {
                    const amount = exp.amount || 0;
                    if (netBalances[exp.paidBy] !== undefined) netBalances[exp.paidBy] += amount;
                    if (exp.logicType === 'i_owe_full' || exp.logicType === 'guest_is_owed_full') {
                        if (netBalances[user.uid] !== undefined) netBalances[user.uid] -= amount;
                    } else if (exp.logicType === 'settlement') {
                        if (netBalances[exp.targetMemberUid] !== undefined) netBalances[exp.targetMemberUid] -= amount;
                    } else {
                        const share = members.length > 0 ? amount / members.length : 0;
                        members.forEach(m => { if (netBalances[m.uid] !== undefined) netBalances[m.uid] -= share; });
                    }
                });
                return { total, perPerson: members.length > 0 ? total / members.length : 0, balances: members.map(m => ({ ...m, balance: netBalances[m.uid] || 0 })) };
            }, [activeGroup, user]);

            const handleLogin = () => signInWithPopup(auth, new GoogleAuthProvider()).catch(e => setErrorMessage(e.message));
            
            const createGroup = async () => {
                if (!newGroupName.trim() || !user) return;
                try {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'groups'), {
                        name: newGroupName,
                        createdBy: user.uid,
                        memberIds: [user.uid],
                        memberEmails: [user.email.toLowerCase()],
                        members: [{ uid: user.uid, name: user.displayName || 'User', email: user.email.toLowerCase(), joined: true }],
                        expenses: [],
                        createdAt: serverTimestamp()
                    });
                    setNewGroupName("");
                } catch (err) { setErrorMessage(err.message); }
            };

            const handleInvite = async (e) => {
                e.preventDefault();
                const email = inviteEmail.toLowerCase().trim();
                if (!activeGroup || !email) return;
                try {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'groups', activeGroup.id), {
                        memberEmails: arrayUnion(email),
                        members: arrayUnion({ uid: `guest_${Date.now()}`, name: email.split('@')[0], email: email, joined: false })
                    });
                    window.location.href = `mailto:${email}?subject=Join SplitSmart&body=Join my group ${activeGroup.name} at ${window.location.href}`;
                    setInviteEmail(""); setShowInviteModal(false);
                } catch (err) { setErrorMessage(err.message); }
            };

            const handleSettle = async (otherMember) => {
                const bal = stats.balances.find(b => b.uid === otherMember.uid)?.balance;
                if (!bal || bal === 0) return;
                const isUserReceiver = bal > 0;
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'groups', activeGroup.id), {
                    expenses: arrayUnion({
                        id: crypto.randomUUID(),
                        description: `Settlement: ${user.displayName} & ${otherMember.name}`,
                        amount: Math.abs(bal),
                        category: 'other',
                        paidBy: isUserReceiver ? user.uid : otherMember.uid,
                        paidByName: isUserReceiver ? user.displayName : otherMember.name,
                        targetMemberUid: isUserReceiver ? otherMember.uid : user.uid,
                        logicType: 'settlement',
                        date: new Date().toISOString()
                    })
                });
            };

            const handleAddExpense = async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const amount = parseFloat(formData.get('amount'));
                const logic = formData.get('splitLogic');
                const targetUid = formData.get('targetMember');
                let paidBy = user.uid, paidByName = user.displayName || 'User';
                if (logic !== 'paid_by_me_split_equally') {
                    const target = (activeGroup.members || []).find(m => m.uid === targetUid);
                    paidBy = target?.uid || 'guest'; paidByName = target?.name || 'Member';
                }
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'groups', activeGroup.id), {
                    expenses: arrayUnion({
                        id: crypto.randomUUID(),
                        description: formData.get('description'),
                        amount,
                        category: formData.get('category'),
                        paidBy, paidByName,
                        logicType: logic,
                        date: new Date().toISOString()
                    })
                });
                setShowAddExpense(false);
            };

            if (loading) return <div className="h-screen flex items-center justify-center font-black text-indigo-600 text-2xl animate-pulse">SPLITSMART</div>;

            if (!user) return (
                <div className="min-h-screen flex items-center justify-center p-6 bg-slate-50">
                    <div className="bg-white p-12 rounded-[3.5rem] shadow-2xl max-w-md w-full text-center space-y-8 border modal-enter">
                        <div className="w-20 h-20 bg-indigo-600 rounded-3xl flex items-center justify-center mx-auto text-white shadow-lg rotate-3">{Icons.car}</div>
                        <h1 className="text-4xl font-black">SplitSmart</h1>
                        {errorMessage && <div className="bg-red-50 text-red-600 p-4 rounded-2xl text-xs font-bold">{errorMessage}</div>}
                        <button onClick={handleLogin} className="w-full py-5 bg-slate-900 text-white rounded-2xl font-black text-lg hover:bg-slate-800 transition-all flex items-center justify-center gap-3">
                            <img src="https://www.google.com/favicon.ico" className="w-5 h-5 invert" /> Continue with Google
                        </button>
                    </div>
                </div>
            );

            return (
                <div className="min-h-screen flex flex-col md:flex-row">
                    {/* Sidebar */}
                    <div className="w-full md:w-80 bg-white border-r p-8 flex flex-col shrink-0">
                        <h2 className="font-black text-2xl text-indigo-600 mb-10 tracking-tighter">SplitSmart</h2>
                        <div className="flex-1 space-y-6 overflow-y-auto">
                            <h3 className="text-[10px] font-black text-slate-400 uppercase tracking-widest px-2">Houses</h3>
                            <div className="space-y-2">
                                {groups.map(g => (
                                    <button key={g.id} onClick={() => setActiveGroup(g)} className={`w-full text-left p-4 rounded-2xl font-black text-sm transition-all ${activeGroup?.id === g.id ? 'bg-indigo-600 text-white shadow-lg' : 'hover:bg-slate-50 text-slate-600'}`}>
                                        {g.name}
                                    </button>
                                ))}
                            </div>
                            <input className="w-full p-4 bg-slate-50 border-2 border-dashed rounded-2xl text-xs font-bold outline-none" placeholder="+ New House (Enter)" value={newGroupName} onChange={e => setNewGroupName(e.target.value)} onKeyDown={e => e.key === 'Enter' && createGroup()} />
                        </div>
                        <div className="mt-8 pt-6 border-t flex items-center gap-4">
                            <div className="w-10 h-10 rounded-full bg-indigo-100 flex items-center justify-center font-black text-indigo-600">{(user.displayName || 'U')[0]}</div>
                            <div className="flex-1 truncate">
                                <p className="font-black text-xs truncate">{user.displayName}</p>
                                <button onClick={() => signOut(auth)} className="text-[10px] font-bold text-red-500 uppercase tracking-widest">Sign Out</button>
                            </div>
                        </div>
                    </div>

                    {/* Main Content */}
                    <div className="flex-1 p-6 md:p-12 overflow-y-auto">
                        {errorMessage && <div className="mb-6 p-4 bg-red-50 text-red-600 rounded-2xl font-bold text-xs">{errorMessage}</div>}
                        {!activeGroup ? <div className="h-full flex flex-col items-center justify-center text-slate-200"><h2 className="text-2xl font-black text-slate-300">Choose a house to start</h2></div> : (
                            <div className="max-w-5xl mx-auto space-y-12">
                                <div className="flex flex-col lg:flex-row lg:items-center justify-between gap-6">
                                    <div><h1 className="text-5xl font-black tracking-tighter">{activeGroup.name}</h1><p className="text-slate-400 font-bold mt-2 uppercase text-[10px] tracking-widest">{activeGroup.members?.length || 0} Members</p></div>
                                    <div className="flex gap-3">
                                        <button onClick={() => setShowInviteModal(true)} className="bg-white border-2 px-6 py-4 rounded-2xl font-black flex items-center gap-2 hover:bg-slate-50">Invite</button>
                                        <button onClick={() => setShowAddExpense(true)} className="bg-indigo-600 text-white px-8 py-4 rounded-2xl font-black shadow-xl hover:bg-indigo-700 active:scale-95">Add Expense</button>
                                    </div>
                                </div>

                                <div className="grid grid-cols-1 md:grid-cols-3 gap-8">
                                    <div className="bg-white p-10 rounded-[3rem] border shadow-sm"><p className="text-[10px] font-black text-slate-400 uppercase mb-4 tracking-widest">Spent</p><h3 className="text-4xl font-black">${stats.total.toFixed(2)}</h3></div>
                                    <div className="bg-white p-10 rounded-[3rem] border shadow-sm"><p className="text-[10px] font-black text-slate-400 uppercase mb-4 tracking-widest">Average</p><h3 className="text-4xl font-black">${stats.perPerson.toFixed(2)}</h3></div>
                                    <div className={`p-10 rounded-[3rem] border shadow-sm ${stats.balances.find(b => b.uid === user.uid)?.balance >= 0 ? 'bg-green-50' : 'bg-red-50'}`}><p className="text-[10px] font-black uppercase mb-4 opacity-60 tracking-widest">Balance</p><h3 className="text-4xl font-black">${Math.abs(stats.balances.find(b => b.uid === user.uid)?.balance || 0).toFixed(2)}</h3></div>
                                </div>

                                <div className="grid grid-cols-1 xl:grid-cols-12 gap-12">
                                    <div className="xl:col-span-8 space-y-6">
                                        <h2 className="text-2xl font-black tracking-tight">Activity</h2>
                                        <div className="space-y-4">
                                            {(activeGroup.expenses || []).length === 0 ? <div className="p-16 text-center text-slate-300 font-bold border-4 border-dashed rounded-[3rem]">Empty ledger</div> : activeGroup.expenses.slice().reverse().map(exp => (
                                                <div key={exp.id} className="bg-white p-6 rounded-3xl border border-slate-100 flex items-center gap-6 hover:shadow-md transition-all border-l-8" style={{borderLeftColor: exp.logicType === 'settlement' ? '#6366f1' : '#f1f5f9'}}>
                                                    <div className="w-12 h-12 bg-indigo-50 text-indigo-600 rounded-2xl flex items-center justify-center shrink-0 w-12 h-12">
                                                        {Icons[CATEGORIES.find(c => c.id === exp.category)?.icon || 'receipt']}
                                                    </div>
                                                    <div className="flex-1 min-w-0"><p className="font-black text-lg truncate">{exp.description}</p><p className="text-xs font-bold text-slate-400 uppercase">Paid by {exp.paidByName || 'Member'}</p></div>
                                                    <p className={`font-black text-2xl shrink-0 ${exp.logicType === 'settlement' ? 'text-indigo-600' : ''}`}>${(exp.amount || 0).toFixed(2)}</p>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                    <div className="xl:col-span-4 space-y-6">
                                        <h2 className="text-2xl font-black tracking-tight">Debts</h2>
                                        <div className="bg-white rounded-[2.5rem] p-6 border space-y-4">
                                            {stats.balances.map(b => (
                                                <div key={b.uid} className="flex items-center justify-between p-4 bg-slate-50 rounded-2xl group">
                                                    <div className="min-w-0"><p className="font-bold text-xs truncate max-w-[100px]">{b.name} {b.uid === user.uid && '(Me)'}</p><p className={`text-[9px] font-black uppercase ${b.balance >= 0 ? 'text-green-600' : 'text-red-600'}`}>${Math.abs(b.balance).toFixed(2)}</p></div>
                                                    {b.uid !== user.uid && Math.abs(b.balance) > 0.01 && <button onClick={() => handleSettle(b)} className="opacity-0 group-hover:opacity-100 bg-indigo-600 text-white px-3 py-1 rounded-lg text-[9px] font-black">Settle</button>}
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>

                    {showInviteModal && (
                        <div className="fixed inset-0 bg-slate-900/40 backdrop-blur-md flex items-center justify-center p-6 z-50">
                            <div className="bg-white rounded-[3rem] p-10 max-w-md w-full modal-enter shadow-2xl">
                                <h2 className="text-3xl font-black mb-6">Invite</h2>
                                <form onSubmit={handleInvite} className="space-y-6">
                                    <input required type="email" value={inviteEmail} onChange={e => setInviteEmail(e.target.value)} className="w-full p-4 bg-slate-50 border-2 rounded-2xl font-bold" placeholder="housemate@email.com" />
                                    <button type="submit" className="w-full py-5 bg-indigo-600 text-white rounded-2xl font-black shadow-xl">Send Link</button>
                                    <button type="button" onClick={() => setShowInviteModal(false)} className="w-full text-slate-400 font-bold uppercase text-[10px]">Cancel</button>
                                </form>
                            </div>
                        </div>
                    )}

                    {showAddExpense && (
                        <div className="fixed inset-0 bg-slate-900/40 backdrop-blur-md flex items-center justify-center p-6 z-50">
                            <div className="bg-white rounded-[3.5rem] p-10 max-w-lg w-full modal-enter shadow-2xl">
                                <h2 className="text-3xl font-black mb-6">Add Bill</h2>
                                <form onSubmit={handleAddExpense} className="space-y-6">
                                    <input name="description" required className="w-full p-4 bg-slate-50 border-2 rounded-2xl font-bold" placeholder="Description" />
                                    <div className="grid grid-cols-2 gap-4">
                                        <input name="amount" type="number" step="0.01" required className="w-full p-4 bg-slate-50 border-2 rounded-2xl font-black" placeholder="0.00" />
                                        <select name="category" className="w-full p-4 bg-slate-50 border-2 rounded-2xl font-bold">
                                            {CATEGORIES.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
                                        </select>
                                    </div>
                                    <select name="splitLogic" value={paymentType} onChange={e => setPaymentType(e.target.value)} className="w-full p-4 bg-indigo-50 border-2 rounded-2xl font-bold">
                                        <option value="paid_by_me_split_equally">I paid, Split Equally</option>
                                        <option value="i_owe_full">I owe another person (full amount)</option>
                                        <option value="guest_paid_split_equally">Someone else paid, Split Equally</option>
                                        <option value="guest_is_owed_full">Someone else is owed full amount</option>
                                    </select>
                                    {paymentType !== 'paid_by_me_split_equally' && (
                                        <select name="targetMember" className="w-full p-4 bg-slate-50 border-2 rounded-2xl font-bold">
                                            {(activeGroup?.members || []).filter(m => m.uid !== user.uid).map(m => (
                                                <option key={m.uid} value={m.uid}>{m.name || 'Member'}</option>
                                            ))}
                                        </select>
                                    )}
                                    <button type="submit" className="w-full py-5 bg-indigo-600 text-white rounded-2xl font-black shadow-xl">Save</button>
                                    <button type="button" onClick={() => setShowAddExpense(false)} className="w-full text-slate-400 font-bold uppercase text-[10px] mt-2">Cancel</button>
                                </form>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
