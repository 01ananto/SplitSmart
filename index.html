<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SplitSmart - House Expenses</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & Babel for Browser -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .modal-enter { animation: zoomIn 0.3s ease-out; }
        @keyframes zoomIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
    </style>
</head>
<body class="bg-slate-50">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        // Import Firebase from CDN
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, onSnapshot, query, where, serverTimestamp, updateDoc, arrayUnion, getDocs } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        /**
         * SECURITY NOTE:
         * To protect your data, you MUST set "Security Rules" in your Firebase Console.
         * Go to Firebase Console > Firestore > Rules and paste this:
         * * service cloud.firestore {
         * match /databases/{database}/documents {
         * match /artifacts/splitsmart-889da/public/data/groups/{groupId} {
         * allow read, write: if request.auth != null;
         * }
         * }
         * }
         */

        // --- YOUR FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyAg5PYPLSBIOlIwTypFkNf8BRGgnIS3FXY",
            authDomain: "splitsmart-889da.firebaseapp.com",
            projectId: "splitsmart-889da",
            storageBucket: "splitsmart-889da.firebasestorage.app",
            messagingSenderId: "265383787810",
            appId: "1:265383787810:web:de28c8f28ce1fd9a9bf97b",
            measurementId: "G-ZN3B2YLXVT"
        };

        const appId = "splitsmart-889da";

        // Initialize Firebase services safely
        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (e) {
            console.error("Firebase Initialization Error.", e);
        }

        const { useState, useEffect, useMemo } = React;

        const Icon = ({ name, size = 20, className = "" }) => {
            useEffect(() => {
                if (window.lucide) window.lucide.createIcons();
            });
            return <i data-lucide={name} style={{width: size, height: size}} className={`inline-block ${className}`}></i>;
        };

        const CATEGORIES = [
            { id: 'food', name: 'Food', icon: 'utensils' },
            { id: 'construction', name: 'Home Construction', icon: 'hammer' },
            { id: 'car', name: 'Car', icon: 'car' },
            { id: 'rent', name: 'Rent', icon: 'home' },
            { id: 'other', name: 'Other', icon: 'receipt' },
        ];

        function App() {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [groups, setGroups] = useState([]);
            const [activeGroup, setActiveGroup] = useState(null);
            const [showAddExpense, setShowAddExpense] = useState(false);
            const [showInviteModal, setShowInviteModal] = useState(false);
            const [newGroupName, setNewGroupName] = useState("");
            const [inviteEmail, setInviteEmail] = useState("");
            const [paymentType, setPaymentType] = useState("paid_by_me_split_equally");
            const [authError, setAuthError] = useState(null);

            useEffect(() => {
                if (!auth) return;
                const unsubscribe = onAuthStateChanged(auth, async (u) => {
                    setUser(u);
                    setLoading(false);
                    if (u && u.email) {
                        const email = u.email.toLowerCase();
                        try {
                            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'groups'), where('memberEmails', 'array-contains', email));
                            const snapshot = await getDocs(q);
                            snapshot.docs.forEach(async (groupDoc) => {
                                const members = groupDoc.data().members || [];
                                let needsUpdate = false;
                                const updatedMembers = members.map(m => {
                                    if (m.email?.toLowerCase() === email && (!m.joined || m.uid.startsWith('guest_'))) {
                                        needsUpdate = true;
                                        return { ...m, uid: u.uid, name: u.displayName || m.name, joined: true };
                                    }
                                    return m;
                                });
                                if (needsUpdate) {
                                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'groups', groupDoc.id), {
                                        members: updatedMembers,
                                        memberIds: arrayUnion(u.uid)
                                    });
                                }
                            });
                        } catch (err) {
                            console.error("Sync error", err);
                        }
                    }
                });
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (!user || !user.email || !db) return;
                const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'groups'), where('memberEmails', 'array-contains', user.email.toLowerCase()));
                return onSnapshot(q, (snapshot) => {
                    const gData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setGroups(gData);
                    if (activeGroup) {
                        const updated = gData.find(g => g.id === activeGroup.id);
                        if (updated) setActiveGroup(updated);
                    } else if (gData.length > 0) {
                        setActiveGroup(gData[0]);
                    }
                }, (err) => console.error("Firestore snapshot error", err));
            }, [user?.email, activeGroup?.id]);

            const stats = useMemo(() => {
                if (!activeGroup || !activeGroup.expenses || !user) return { total: 0, perPerson: 0, balances: [] };
                const expenses = activeGroup.expenses;
                const members = activeGroup.members || [];
                const total = expenses.reduce((sum, exp) => sum + exp.amount, 0);
                const netBalances = {};
                members.forEach(m => { if(m.uid) netBalances[m.uid] = 0; });

                expenses.forEach(exp => {
                    const amount = exp.amount;
                    if (netBalances[exp.paidBy] !== undefined) netBalances[exp.paidBy] += amount;
                    if (exp.logicType === 'i_owe_full' || exp.logicType === 'guest_is_owed_full') {
                        if (netBalances[user.uid] !== undefined) netBalances[user.uid] -= amount;
                    } else {
                        const share = amount / (members.length || 1);
                        members.forEach(m => {
                            if (m.uid && netBalances[m.uid] !== undefined) netBalances[m.uid] -= share;
                        });
                    }
                });
                return { 
                    total, 
                    perPerson: total / (members.length || 1), 
                    balances: members.map(m => ({ ...m, balance: netBalances[m.uid] || 0 })) 
                };
            }, [activeGroup, user]);

            const handleLogin = async () => {
                setAuthError(null);
                try {
                    await signInWithPopup(auth, new GoogleAuthProvider());
                } catch (error) {
                    console.error("Login Error", error);
                    if (error.code === 'auth/unauthorized-domain') {
                        setAuthError("This domain is not authorized. Please add your GitHub URL to 'Authorized Domains' in your Firebase Console.");
                    } else {
                        setAuthError("Login failed: " + error.message);
                    }
                }
            };
            
            const createGroup = async () => {
                if (!newGroupName.trim() || !user || !user.email) return;
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'groups'), {
                    name: newGroupName,
                    createdBy: user.uid,
                    memberIds: [user.uid],
                    memberEmails: [user.email.toLowerCase()],
                    members: [{ uid: user.uid, name: user.displayName || 'User', email: user.email.toLowerCase(), joined: true }],
                    expenses: [],
                    createdAt: serverTimestamp()
                });
                setNewGroupName("");
            };

            const handleInvite = async (e) => {
                e.preventDefault();
                const email = inviteEmail.toLowerCase().trim();
                if (!activeGroup || !email) return;
                if (activeGroup.memberEmails?.includes(email)) return;

                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'groups', activeGroup.id), {
                    memberEmails: arrayUnion(email),
                    members: arrayUnion({ 
                        uid: `guest_${Date.now()}`, 
                        name: email.split('@')[0], 
                        email: email, 
                        joined: false 
                    })
                });
                
                const subject = encodeURIComponent(`Join SplitSmart: ${activeGroup.name}`);
                const body = encodeURIComponent(`I've invited you to split expenses for ${activeGroup.name}. Join here: ${window.location.href}`);
                window.location.href = `mailto:${email}?subject=${subject}&body=${body}`;
                
                setInviteEmail("");
                setShowInviteModal(false);
            };

            const handleAddExpense = async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const amount = parseFloat(formData.get('amount'));
                const logic = formData.get('splitLogic');
                const targetUid = formData.get('targetMember');
                
                let paidBy = user.uid;
                let paidByName = user.displayName || 'User';

                if (logic !== 'paid_by_me_split_equally') {
                    const target = activeGroup.members.find(m => m.uid === targetUid);
                    paidBy = target?.uid || 'guest';
                    paidByName = target?.name || 'Member';
                }

                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'groups', activeGroup.id), {
                    expenses: arrayUnion({
                        id: crypto.randomUUID(),
                        description: formData.get('description'),
                        amount,
                        category: formData.get('category'),
                        paidBy,
                        paidByName,
                        logicType: logic,
                        date: new Date().toISOString()
                    })
                });
                setShowAddExpense(false);
            };

            if (loading) return <div className="flex h-screen items-center justify-center font-black text-indigo-600 animate-pulse uppercase tracking-widest">Splitsmart</div>;

            if (!user) return (
                <div className="flex flex-col items-center justify-center min-h-screen p-6 bg-slate-50">
                    <div className="bg-white p-12 rounded-[3.5rem] shadow-2xl max-w-md w-full text-center space-y-8 border border-slate-100">
                        <div className="w-20 h-20 bg-indigo-600 rounded-3xl flex items-center justify-center mx-auto shadow-lg rotate-3">
                            <Icon name="credit-card" size={40} className="text-white" />
                        </div>
                        <h1 className="text-4xl font-black text-slate-900 tracking-tight">SplitSmart</h1>
                        <p className="text-slate-500 font-bold">House expenses, perfectly balanced.</p>
                        
                        {authError && (
                            <div className="bg-red-50 text-red-600 p-4 rounded-2xl text-xs font-bold border border-red-100 leading-relaxed">
                                {authError}
                            </div>
                        )}

                        <button onClick={handleLogin} className="w-full py-5 bg-slate-900 text-white rounded-2xl font-black text-lg hover:bg-slate-800 transition-all flex items-center justify-center gap-3">
                            <img src="https://www.google.com/favicon.ico" className="w-5 h-5 invert" />
                            Continue with Google
                        </button>
                    </div>
                </div>
            );

            return (
                <div className="min-h-screen flex flex-col md:flex-row bg-slate-50">
                    {/* Sidebar */}
                    <div className="w-full md:w-80 bg-white border-r p-8 flex flex-col shrink-0">
                        <div className="flex items-center gap-3 mb-10">
                            <div className="bg-indigo-600 p-2 rounded-lg text-white shadow-sm"><Icon name="credit-card" size={20} /></div>
                            <h2 className="font-black text-2xl tracking-tighter">SplitSmart</h2>
                        </div>
                        <div className="flex-1 space-y-6 overflow-y-auto">
                            <h3 className="text-[10px] font-black text-slate-400 uppercase tracking-widest px-2">Houses</h3>
                            <div className="space-y-2">
                                {groups.map(g => (
                                    <button key={g.id} onClick={() => setActiveGroup(g)} className={`w-full text-left p-4 rounded-2xl font-black text-sm flex items-center gap-3 transition-all ${activeGroup?.id === g.id ? 'bg-indigo-600 text-white shadow-xl shadow-indigo-100' : 'hover:bg-slate-50 text-slate-600'}`}>
                                        <Icon name="home" size={18} />
                                        <span className="truncate">{g.name}</span>
                                    </button>
                                ))}
                            </div>
                            <input 
                                className="w-full p-4 bg-slate-50 border-2 border-dashed rounded-2xl text-xs font-bold focus:border-indigo-500 outline-none" 
                                placeholder="+ New House Name" 
                                value={newGroupName} 
                                onChange={e => setNewGroupName(e.target.value)} 
                                onKeyDown={e => e.key === 'Enter' && createGroup()}
                            />
                        </div>
                        <div className="mt-8 pt-6 border-t flex items-center gap-4">
                            <div className="w-10 h-10 rounded-full bg-indigo-100 flex items-center justify-center font-black text-indigo-600 text-sm capitalize">
                                {(user.displayName || 'U')[0]}
                            </div>
                            <div className="flex-1 truncate">
                                <p className="font-black text-xs truncate">{user.displayName || 'User'}</p>
                                <button onClick={() => signOut(auth)} className="text-[10px] font-bold text-red-500 uppercase tracking-widest">Sign Out</button>
                            </div>
                        </div>
                    </div>

                    {/* Main Content */}
                    <div className="flex-1 p-6 md:p-12 overflow-y-auto">
                        {!activeGroup ? (
                            <div className="h-full flex flex-col items-center justify-center text-slate-200">
                                <Icon name="users" size={80} className="mb-4 opacity-20" />
                                <p className="font-black text-xl">Select a house to begin</p>
                            </div>
                        ) : (
                            <div className="max-w-5xl mx-auto space-y-12">
                                <div className="flex flex-col lg:flex-row lg:items-center justify-between gap-6">
                                    <div>
                                        <h1 className="text-5xl font-black text-slate-900 tracking-tighter">{activeGroup.name}</h1>
                                        <p className="text-slate-400 font-bold mt-2 uppercase text-[10px] tracking-widest">{activeGroup.members?.length || 0} Members</p>
                                    </div>
                                    <div className="flex gap-3">
                                        <button onClick={() => setShowInviteModal(true)} className="bg-white border-2 px-6 py-4 rounded-2xl font-black flex items-center gap-2 hover:bg-slate-50 transition-all">
                                            <Icon name="user-plus" /> Invite
                                        </button>
                                        <button onClick={() => setShowAddExpense(true)} className="bg-indigo-600 text-white px-8 py-4 rounded-2xl font-black shadow-xl hover:bg-indigo-700 transition-all active:scale-95">
                                            Add Expense
                                        </button>
                                    </div>
                                </div>

                                <div className="grid grid-cols-1 md:grid-cols-3 gap-8">
                                    <div className="bg-white p-10 rounded-[3rem] shadow-sm border border-slate-100">
                                        <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-4">Total Spending</p>
                                        <h3 className="text-4xl font-black text-indigo-600">${stats.total.toFixed(2)}</h3>
                                    </div>
                                    <div className="bg-white p-10 rounded-[3rem] shadow-sm border border-slate-100">
                                        <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-4">Per Person</p>
                                        <h3 className="text-4xl font-black text-slate-800">${stats.perPerson.toFixed(2)}</h3>
                                    </div>
                                    <div className={`p-10 rounded-[3rem] shadow-sm border ${stats.balances.find(b => b.uid === user.uid)?.balance >= 0 ? 'bg-green-50 border-green-100' : 'bg-red-50 border-red-100'}`}>
                                        <p className="text-[10px] font-black uppercase tracking-widest mb-4 opacity-60">Your Balance</p>
                                        <h3 className={`text-4xl font-black ${stats.balances.find(b => b.uid === user.uid)?.balance >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                            ${Math.abs(stats.balances.find(b => b.uid === user.uid)?.balance || 0).toFixed(2)}
                                        </h3>
                                    </div>
                                </div>

                                <div className="grid grid-cols-1 xl:grid-cols-12 gap-12">
                                    <div className="xl:col-span-8 space-y-6">
                                        <h2 className="text-2xl font-black tracking-tight flex items-center gap-3">
                                            <Icon name="receipt" className="text-indigo-600" />
                                            Recent Activity
                                        </h2>
                                        <div className="space-y-4">
                                            {activeGroup.expenses?.slice().reverse().map(exp => (
                                                <div key={exp.id} className="bg-white p-6 rounded-3xl border border-slate-100 flex items-center gap-6 hover:shadow-lg transition-all">
                                                    <div className="w-12 h-12 bg-indigo-50 text-indigo-600 rounded-2xl flex items-center justify-center">
                                                        <Icon name={CATEGORIES.find(c => c.id === exp.category)?.icon || 'receipt'} />
                                                    </div>
                                                    <div className="flex-1 min-w-0">
                                                        <p className="font-black text-lg text-slate-900">{exp.description}</p>
                                                        <p className="text-xs font-bold text-slate-400 uppercase">Paid by {exp.paidByName || 'Member'} â€¢ {new Date(exp.date).toLocaleDateString()}</p>
                                                    </div>
                                                    <p className="font-black text-2xl text-slate-900">${exp.amount.toFixed(2)}</p>
                                                </div>
                                            ))}
                                            {(!activeGroup.expenses || activeGroup.expenses.length === 0) && (
                                                <div className="p-16 text-center text-slate-300 font-bold border-4 border-dashed rounded-[3rem]">No bills logged yet.</div>
                                            )}
                                        </div>
                                    </div>
                                    <div className="xl:col-span-4 space-y-6">
                                        <h2 className="text-2xl font-black tracking-tight flex items-center gap-3">
                                            <Icon name="trending-up" className="text-indigo-600" />
                                            Balances
                                        </h2>
                                        <div className="bg-white rounded-[2.5rem] p-6 border border-slate-100 space-y-4">
                                            {stats.balances.map(b => (
                                                <div key={b.uid} className="flex items-center justify-between p-4 bg-slate-50 rounded-2xl">
                                                    <div className="flex items-center gap-3">
                                                        <div className={`w-8 h-8 rounded-lg flex items-center justify-center text-[10px] font-black text-white ${b.balance >= 0 ? 'bg-green-500' : 'bg-red-400'}`}>
                                                            {(b.name || 'U')[0].toUpperCase()}
                                                        </div>
                                                        <p className="font-bold text-xs truncate max-w-[100px]">{b.name || 'User'} {b.uid === user.uid && '(Me)'}</p>
                                                    </div>
                                                    <p className={`font-black text-sm ${b.balance >= 0 ? 'text-green-600' : 'text-red-500'}`}>
                                                        ${Math.abs(b.balance).toFixed(2)}
                                                    </p>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>

                    {/* Invite Modal */}
                    {showInviteModal && (
                        <div className="fixed inset-0 bg-slate-900/40 backdrop-blur-md flex items-center justify-center p-6 z-50">
                            <div className="bg-white rounded-[3rem] p-10 max-w-md w-full modal-enter shadow-2xl">
                                <h2 className="text-3xl font-black mb-6">Invite Member</h2>
                                <form onSubmit={handleInvite} className="space-y-6">
                                    <div>
                                        <label className="text-[10px] font-black text-slate-400 uppercase mb-2 block px-2">Email Address</label>
                                        <input 
                                            required type="email" value={inviteEmail} onChange={e => setInviteEmail(e.target.value)} 
                                            className="w-full p-4 bg-slate-50 border-2 rounded-2xl font-bold outline-none focus:border-indigo-500" 
                                            placeholder="housemate@email.com" 
                                        />
                                    </div>
                                    <button type="submit" className="w-full py-5 bg-indigo-600 text-white rounded-2xl font-black shadow-xl hover:bg-indigo-700 transition-all">Send Invitation</button>
                                    <button type="button" onClick={() => setShowInviteModal(false)} className="w-full text-slate-400 font-bold uppercase text-[10px] tracking-widest">Cancel</button>
                                </form>
                            </div>
                        </div>
                    )}

                    {/* Add Expense Modal */}
                    {showAddExpense && (
                        <div className="fixed inset-0 bg-slate-900/40 backdrop-blur-md flex items-center justify-center p-6 z-50">
                            <div className="bg-white rounded-[3rem] p-10 max-w-lg w-full modal-enter shadow-2xl">
                                <h2 className="text-3xl font-black mb-6">Add Bill</h2>
                                <form onSubmit={handleAddExpense} className="space-y-6">
                                    <div className="grid grid-cols-2 gap-4">
                                        <div className="col-span-2">
                                            <label className="text-[10px] font-black text-slate-400 uppercase mb-2 block px-2">Description</label>
                                            <input name="description" required className="w-full p-4 bg-slate-50 border-2 rounded-2xl font-bold outline-none" placeholder="e.g. Weekly Groceries" />
                                        </div>
                                        <div>
                                            <label className="text-[10px] font-black text-slate-400 uppercase mb-2 block px-2">Amount ($)</label>
                                            <input name="amount" type="number" step="0.01" required className="w-full p-4 bg-slate-50 border-2 rounded-2xl font-black text-xl outline-none" placeholder="0.00" />
                                        </div>
                                        <div>
                                            <label className="text-[10px] font-black text-slate-400 uppercase mb-2 block px-2">Category</label>
                                            <select name="category" className="w-full p-4 bg-slate-50 border-2 rounded-2xl font-bold outline-none">
                                                {CATEGORIES.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
                                            </select>
                                        </div>
                                    </div>
                                    <div>
                                        <label className="text-[10px] font-black text-slate-400 uppercase mb-2 block px-2">Split Logic</label>
                                        <select 
                                            name="splitLogic" value={paymentType} onChange={e => setPaymentType(e.target.value)}
                                            className="w-full p-4 bg-indigo-50 border-2 border-indigo-100 text-indigo-900 rounded-2xl font-bold outline-none"
                                        >
                                            <option value="paid_by_me_split_equally">I paid, Split Equally</option>
                                            <option value="i_owe_full">I owe another person (full amount)</option>
                                            <option value="guest_paid_split_equally">Someone else paid, Split Equally</option>
                                            <option value="guest_is_owed_full">Someone else is owed full amount</option>
                                        </select>
                                    </div>
                                    {paymentType !== 'paid_by_me_split_equally' && (
                                        <div>
                                            <label className="text-[10px] font-black text-slate-400 uppercase mb-2 block px-2">Which house member?</label>
                                            <select name="targetMember" className="w-full p-4 bg-slate-50 border-2 rounded-2xl font-bold outline-none">
                                                {activeGroup.members?.filter(m => m.uid !== user.uid).map(m => (
                                                    <option key={m.uid} value={m.uid}>{m.name || 'Member'}</option>
                                                ))}
                                            </select>
                                        </div>
                                    )}
                                    <button type="submit" className="w-full py-5 bg-indigo-600 text-white rounded-2xl font-black shadow-xl hover:bg-indigo-700 transition-all">Save Expense</button>
                                    <button type="button" onClick={() => setShowAddExpense(false)} className="w-full text-slate-400 font-bold uppercase text-[10px] tracking-widest">Cancel</button>
                                </form>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
